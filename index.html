<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v6.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="https://d3js.org/d3-array.v2.min.js"></script>
<script src="https://d3js.org/d3-geo.v2.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v3.min.js"></script>

<!-- Create an element where the map will take place -->
<svg id="my_dataviz" width="600" height="600"></svg>
<script>

  // The svg
  var svg = d3.select("svg"),
      width = +svg.attr("width"),
      height = +svg.attr("height");

  // Map and projection
  var projection = d3.geoMercator()
      .center([-74, 40.78]) // GPS of location to zoom on
      .scale(50000) // This is like the zoom
      .translate([ width/2, height/2 ]);


  // get NYC map
  d3.json("https://raw.githubusercontent.com/codeforamerica/click_that_hood/master/public/data/new-york-city-boroughs.geojson").then(mapData => {
      // Draw the map
      svg.append("g")
          .selectAll("path")
          .data(mapData.features)
          .enter()
          .append("path")
            .attr("fill", "#b8b8b8")
            .attr("d", d3.geoPath()
                .projection(projection)
            )
          .style("stroke", "black")
          .style("opacity", .3);

          // get station data (name, location, etc)
          d3.csv("https://raw.githubusercontent.com/6859-sp21/a4-flights-across-time-and-space/main/data/Stations.csv").then(stationData => {
            // get turnstile data
            d3.csv("https://raw.githubusercontent.com/6859-sp21/a4-flights-across-time-and-space/main/data/MTA_formatted.csv").then(MTAData => {
      

              var counts = MTAData.filter(c => c.DATE === '01/19');
              var bubbleData = [];
              let done = [];
              for (let i=0; i < stationData.length; i++){
                if (!done.includes(stationData[i]['Stop Name'].toUpperCase())){
                  let countPts = counts.filter(c => c.STATION === stationData[i]['Stop Name'].toUpperCase());
                  if (countPts.length > 0){
                    let d = {};
                    d.long = stationData[i]['GTFS Longitude'];
                    d.lat = stationData[i]['GTFS Latitude'];
                    d.group = stationData[i].Borough;
                    d.size = countPts[0].ENTRIES/10000000000.0;
                    bubbleData.push(d);
                    done.push(stationData[i]['Stop Name'].toUpperCase());
                  }
                }
              }

              svg
              .selectAll("myCircles")
              .data(bubbleData)
              .enter()
              .append("circle")
                .attr("cx", function(d){ return projection([d.long, d.lat])[0] })
                .attr("cy", function(d){ return projection([d.long, d.lat])[1] })
                .attr("r", function(d){ return d.size })
                .style("fill", "69b3a2")
                .attr("stroke", "#69b3a2")
                .attr("stroke-width", 3)
                .attr("fill-opacity", .4)

            });

          });
  });


</script>